// Generated by CoffeeScript 1.9.1
(function() {
  var DEFAULT_SITES, filter, listen, listener, reload, storage, unlisten;

  DEFAULT_SITES = [
    {
      hostSuffix: "reddit.com"
    }, {
      hostSuffix: "news.ycombinator.com"
    }, {
      hostSuffix: "facebook.com"
    }, {
      hostSuffix: "twitter.com"
    }
  ];

  storage = chrome.storage.sync;

  filter = null;

  listener = function(ev) {
    if (ev.frameId > 0) {
      return;
    }
    chrome.tabs.update(ev.tabId, {
      url: "about:blank"
    });
    if (confirm("Are you sure you want to visit " + ev.url + " ?")) {
      chrome.tabs.update(ev.tabId, {
        url: ev.url
      });
      unlisten();
      return chrome.alarms.create({
        delayInMinutes: 5
      });
    }
  };

  listen = function() {
    chrome.alarms.clearAll();
    return chrome.webNavigation.onBeforeNavigate.addListener(listener, filter);
  };

  unlisten = function() {
    return chrome.webNavigation.onBeforeNavigate.removeListener(listener);
  };

  reload = function() {
    return storage.get('sites', function(result) {
      if (!(result && Array.isArray(result.sites))) {
        return;
      }
      filter = {
        url: result.sites
      };
      unlisten();
      return listen();
    });
  };

  storage.get('sites', function(result) {
    if (result && Array.isArray(result.sites)) {
      filter = {
        url: result.sites
      };
    } else {
      filter = {
        url: DEFAULT_SITES
      };
      storage.set({
        sites: DEFAULT_SITES
      });
    }
    return listen();
  });

  chrome.alarms.onAlarm.addListener(listen);

  chrome.storage.onChanged.addListener(reload);

}).call(this);
